# æ˜Ÿæ²³ï¼ˆXingheï¼‰AI è§†é¢‘åˆ›ä½œè½¯ä»¶ - å®Œæ•´æŠ€æœ¯æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
> **æ›´æ–°æ—¥æœŸ**: 2026-01-19  
> **ç›®æ ‡è¯»è€…**: AI å¤§è¯­è¨€æ¨¡å‹ã€å¼€å‘è€…ã€æ¶æ„å¸ˆ

---

## ğŸ“– ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆ](#2-æŠ€æœ¯æ ˆ)
3. [æ ¸å¿ƒæ¶æ„](#3-æ ¸å¿ƒæ¶æ„)
4. [API æ¶æ„ï¼ˆé‡ç‚¹ï¼‰](#4-api-æ¶æ„é‡ç‚¹)
5. [è‡ªåŠ¨æ¨¡å¼è¯¦è§£](#5-è‡ªåŠ¨æ¨¡å¼è¯¦è§£)
6. [æ‰‹åŠ¨æ¨¡å¼è¯¦è§£](#6-æ‰‹åŠ¨æ¨¡å¼è¯¦è§£)
7. [æ•°æ®å­˜å‚¨æ¶æ„](#7-æ•°æ®å­˜å‚¨æ¶æ„)
8. [æœåŠ¡å±‚è®¾è®¡](#8-æœåŠ¡å±‚è®¾è®¡)
9. [çŠ¶æ€ç®¡ç†](#9-çŠ¶æ€ç®¡ç†)
10. [æ€§èƒ½ä¼˜åŒ–](#10-æ€§èƒ½ä¼˜åŒ–)
11. [ä»£ç è§„èŒƒ](#11-ä»£ç è§„èŒƒ)
12. [å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ](#12-å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ)
13. [æœªæ¥æ‰©å±•æ–¹å‘](#13-æœªæ¥æ‰©å±•æ–¹å‘)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

**æ˜Ÿæ²³ï¼ˆXingheï¼‰** æ˜¯ä¸€æ¬¾åŸºäº Flutter å¼€å‘çš„ **AI é©±åŠ¨çš„è§†é¢‘åˆ›ä½œè½¯ä»¶**ï¼Œæ—¨åœ¨é€šè¿‡ AI æŠ€æœ¯ç®€åŒ–è§†é¢‘åˆ›ä½œæµç¨‹ï¼Œè®©ç”¨æˆ·ä»…éœ€è¾“å…¥åˆ›æ„å³å¯ç”Ÿæˆå®Œæ•´è§†é¢‘ã€‚

### 1.2 æ ¸å¿ƒèƒ½åŠ›

- âœ… **AI å‰§æœ¬ç”Ÿæˆ**: åŸºäº LLM ç”Ÿæˆå®Œæ•´å‰§æœ¬
- âœ… **AI åˆ†é•œè®¾è®¡**: è‡ªåŠ¨ç”Ÿæˆåˆ†é•œè®¾è®¡å’Œæç¤ºè¯
- âœ… **AI å›¾ç‰‡ç”Ÿæˆ**: æ‰¹é‡ç”Ÿæˆåœºæ™¯å›¾ç‰‡
- âœ… **AI è§†é¢‘ç”Ÿæˆ**: å°†å›¾ç‰‡è½¬æ¢ä¸ºè§†é¢‘
- âœ… **è§†é¢‘åˆæˆ**: ä½¿ç”¨ FFmpeg åˆå¹¶æ‰€æœ‰åœºæ™¯è§†é¢‘
- âœ… **å¤šæ¨¡å¼å·¥ä½œæµ**: è‡ªåŠ¨æ¨¡å¼å’Œæ‰‹åŠ¨æ¨¡å¼
- âœ… **å¤šä¾›åº”å•†æ”¯æŒ**: å¯ä¸º LLM/å›¾ç‰‡/è§†é¢‘åˆ†åˆ«é…ç½® API ä¾›åº”å•†

### 1.3 åº”ç”¨åœºæ™¯

- **çŸ­è§†é¢‘åˆ›ä½œ**: å¿«é€Ÿç”Ÿæˆç¤¾äº¤åª’ä½“çŸ­è§†é¢‘
- **æ•…äº‹å¯è§†åŒ–**: å°†æ–‡å­—æ•…äº‹è½¬æ¢ä¸ºè§†é¢‘
- **æ•™è‚²å†…å®¹**: ç”Ÿæˆæ•™å­¦æ¼”ç¤ºè§†é¢‘
- **è¥é”€ç´ æ**: æ‰¹é‡ç”Ÿæˆäº§å“å±•ç¤ºè§†é¢‘

---

## 2. æŠ€æœ¯æ ˆ

### 2.1 æ ¸å¿ƒæ¡†æ¶

- **Flutter 3.10.4+**: è·¨å¹³å° UI æ¡†æ¶
- **Dart SDK 3.10.4+**: ç¼–ç¨‹è¯­è¨€

### 2.2 ä¸»è¦ä¾èµ–

#### UI å’Œåª’ä½“
```yaml
video_player: ^2.8.3          # è§†é¢‘æ’­æ”¾
image_picker: ^1.2.1          # å›¾ç‰‡é€‰æ‹©
file_picker: ^10.3.8          # æ–‡ä»¶é€‰æ‹©
```

#### ç½‘ç»œå’Œ API
```yaml
http: ^1.2.1                  # HTTP è¯·æ±‚
dio: ^5.9.0                   # é«˜çº§ HTTP å®¢æˆ·ç«¯
supabase_flutter: ^2.5.6      # Supabase é›†æˆï¼ˆæ–‡ä»¶å­˜å‚¨ï¼‰
```

#### æ•°æ®æŒä¹…åŒ–
```yaml
hive: ^2.2.3                  # NoSQL æ•°æ®åº“
hive_flutter: ^1.1.0          # Hive Flutter é›†æˆ
shared_preferences: ^2.2.2    # é”®å€¼å¯¹å­˜å‚¨
```

#### çŠ¶æ€ç®¡ç†
```yaml
provider: ^6.1.2              # çŠ¶æ€ç®¡ç†åº“
```

#### å¹¶å‘å’Œæ€§èƒ½
```yaml
pool: ^1.5.1                  # å¹¶å‘ä»»åŠ¡æ± 
synchronized: ^3.1.0+1        # åŒæ­¥æ§åˆ¶
```

#### å·¥å…·ç±»
```yaml
path_provider: ^2.1.5         # è·¯å¾„è·å–
crypto: ^3.0.5                # åŠ å¯†
flutter_dotenv: ^5.1.0        # ç¯å¢ƒå˜é‡
package_info_plus: ^8.0.2     # åº”ç”¨ä¿¡æ¯
url_launcher: ^6.3.2          # URL å¯åŠ¨
```

### 2.3 å¤–éƒ¨å·¥å…·

- **FFmpeg**: è§†é¢‘å¤„ç†ï¼ˆéœ€ç”¨æˆ·å®‰è£…ï¼‰
- **Supabase**: æ–‡ä»¶å­˜å‚¨å’Œæ‰˜ç®¡

---

## 3. æ ¸å¿ƒæ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨å±‚ (UI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è‡ªåŠ¨æ¨¡å¼ UI  â”‚       æ‰‹åŠ¨æ¨¡å¼ UI              â”‚   è®¾ç½® UI     â”‚
â”‚ (AutoMode    â”‚  (Workspace Panels)           â”‚ (Settings)   â”‚
â”‚  Screen)     â”‚                               â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                     â†“                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      çŠ¶æ€ç®¡ç†å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AutoMode     â”‚     StatefulWidget            â”‚  Config      â”‚
â”‚ Provider     â”‚     (å„é¢æ¿ç‹¬ç«‹çŠ¶æ€)           â”‚  Managers    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                     â†“                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æœåŠ¡å±‚ (Services)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ApiManager   â”‚ ApiService   â”‚ FFmpegServiceâ”‚ PromptStore    â”‚
â”‚ (å¤šä¾›åº”å•†)    â”‚              â”‚              â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ApiConfig    â”‚ HeavyTask    â”‚ Generation   â”‚ UpdateService  â”‚
â”‚ Manager      â”‚ Runner       â”‚ Queue        â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                     â†“                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å­˜å‚¨å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hive Box     â”‚   SharedPreferences           â”‚  Supabase    â”‚
â”‚ (è‡ªåŠ¨æ¨¡å¼)    â”‚   (æ‰‹åŠ¨æ¨¡å¼+é…ç½®)              â”‚  (æ–‡ä»¶å­˜å‚¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                     â†“                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¤–éƒ¨æœåŠ¡å’Œå·¥å…·                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LLM API      â”‚   Image API                   â”‚  Video API   â”‚
â”‚ (Geeknowç­‰)  â”‚   (Geeknowç­‰)                 â”‚  (Geeknowç­‰) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     FFmpeg (è§†é¢‘å¤„ç†)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 é¡¹ç›®æ–‡ä»¶ç»“æ„

```
lib/
â”œâ”€â”€ main.dart                          # åº”ç”¨å…¥å£ + æ‰‹åŠ¨æ¨¡å¼ UI
â”œâ”€â”€ logic/
â”‚   â””â”€â”€ auto_mode_provider.dart        # è‡ªåŠ¨æ¨¡å¼çŠ¶æ€ç®¡ç†ï¼ˆå•ä¾‹ï¼‰
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ auto_mode_project.dart         # è‡ªåŠ¨æ¨¡å¼é¡¹ç›®æ¨¡å‹
â”‚   â”œâ”€â”€ auto_mode_step.dart            # å·¥ä½œæµæ­¥éª¤æšä¸¾
â”‚   â”œâ”€â”€ scene_model.dart               # åœºæ™¯æ¨¡å‹
â”‚   â”œâ”€â”€ scene_status.dart              # åœºæ™¯çŠ¶æ€æšä¸¾
â”‚   â”œâ”€â”€ character_model.dart           # è§’è‰²æ¨¡å‹
â”‚   â””â”€â”€ prompt_template.dart           # æç¤ºè¯æ¨¡æ¿æ¨¡å‹
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ auto_mode_screen.dart          # è‡ªåŠ¨æ¨¡å¼ UI
â”‚   â””â”€â”€ prompt_config_view.dart        # æç¤ºè¯é…ç½® UI
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api_manager.dart               # API ç®¡ç†å™¨ï¼ˆæ··åˆä¾›åº”å•†ï¼‰
â”‚   â”œâ”€â”€ api_config_manager.dart        # API é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ api_service.dart               # API è°ƒç”¨æœåŠ¡
â”‚   â”œâ”€â”€ ffmpeg_service.dart            # FFmpeg è§†é¢‘å¤„ç†
â”‚   â”œâ”€â”€ heavy_task_runner.dart         # å¹¶å‘ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ generation_queue.dart          # ç”Ÿæˆé˜Ÿåˆ—ç®¡ç†
â”‚   â”œâ”€â”€ prompt_store.dart              # æç¤ºè¯æ¨¡æ¿å­˜å‚¨
â”‚   â”œâ”€â”€ update_service.dart            # è‡ªåŠ¨æ›´æ–°æœåŠ¡
â”‚   â”œâ”€â”€ sora_api_service.dart          # æ—§ API æœåŠ¡ï¼ˆå·²åºŸå¼ƒï¼‰
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ base_provider.dart         # API ä¾›åº”å•†åŸºç±»
â”‚   â”‚   â””â”€â”€ geeknow_provider.dart      # Geeknow ä¾›åº”å•†å®ç°
â”‚   â””â”€â”€ index.dart                     # æœåŠ¡å¯¼å‡º
â”œâ”€â”€ widgets/
â”‚   â”œâ”€â”€ provider_selector.dart         # ä¾›åº”å•†é€‰æ‹©å™¨ç»„ä»¶
â”‚   â””â”€â”€ README_PROVIDER_SELECTOR.md    # ç»„ä»¶æ–‡æ¡£
â””â”€â”€ save_settings_panel.dart           # ä¿å­˜è®¾ç½®é¢æ¿
```

---

## 4. API æ¶æ„ï¼ˆé‡ç‚¹ï¼‰

### 4.1 æ¶æ„æ¼”è¿›

#### **ç¬¬ä¸€ä»£ï¼šå•ä¸€æœåŠ¡æ¶æ„**ï¼ˆå·²åºŸå¼ƒï¼‰
```dart
SoraApiService
  â†“
æ‰€æœ‰ API è°ƒç”¨ï¼ˆLLMã€å›¾ç‰‡ã€è§†é¢‘ï¼‰
```

#### **ç¬¬äºŒä»£ï¼šæ’ä»¶åŒ–æ¶æ„**ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
```dart
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ApiManager (å•ä¾‹)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  _llmProvider      â†’ BaseApiProvider              â”‚
â”‚  _imageProvider    â†’ BaseApiProvider              â”‚
â”‚  _videoProvider    â†’ BaseApiProvider              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  _providersCache   â†’ Map<String, BaseApiProvider> â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                 â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GeeknowProviderâ”‚ â”‚OpenAIProviderâ”‚ â”‚CustomProviderâ”‚
â”‚ (ç»§æ‰¿Base)      â”‚ â”‚ (æœªæ¥)       â”‚ â”‚ (æœªæ¥)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ ¸å¿ƒç±»è¯¦è§£

#### **BaseApiProviderï¼ˆæŠ½è±¡åŸºç±»ï¼‰**

```dart
// ä½ç½®: lib/services/providers/base_provider.dart

/// API ä¾›åº”å•†åŸºç±» - å®šä¹‰ç»Ÿä¸€æ¥å£
abstract class BaseApiProvider {
  final String baseUrl;
  final String apiKey;
  final String providerName;
  
  BaseApiProvider({
    required this.baseUrl,
    required this.apiKey,
    required this.providerName,
  });
  
  // æŠ½è±¡æ–¹æ³•ï¼ˆå­ç±»å¿…é¡»å®ç°ï¼‰
  
  /// LLM èŠå¤©è¡¥å…¨
  Future<String> chatCompletion({
    required String model,
    required List<Map<String, dynamic>> messages,
    double temperature = 0.7,
    int maxTokens = 2048,
  });
  
  /// å›¾ç‰‡ç”Ÿæˆ
  Future<String> generateImage({
    required String prompt,
    required String model,
    String? size,
    String? negativePrompt,
  });
  
  /// åˆ›å»ºè§†é¢‘ä»»åŠ¡
  Future<String> createVideo({
    required String prompt,
    required String model,
    String? imageUrl,
  });
  
  /// æŸ¥è¯¢è§†é¢‘ä»»åŠ¡çŠ¶æ€
  Future<VideoTaskStatus> getVideoTask({
    required String taskId,
  });
  
  /// ä¸Šä¼ è§†é¢‘åˆ° OSS
  Future<String> uploadVideoToOss(File videoFile);
  
  /// åˆ›å»ºè§’è‰²
  Future<Map<String, dynamic>> createCharacter(String videoUrl);
}
```

#### **ApiManagerï¼ˆå•ä¾‹ç®¡ç†å™¨ï¼‰**

```dart
// ä½ç½®: lib/services/api_manager.dart

/// API ç®¡ç†å™¨ - æ”¯æŒæ··åˆä¾›åº”å•†æ¨¡å¼
class ApiManager {
  static final ApiManager _instance = ApiManager._internal();
  factory ApiManager() => _instance;
  
  // ä¸‰ä¸ªç‹¬ç«‹çš„ Provider
  BaseApiProvider? _llmProvider;
  BaseApiProvider? _imageProvider;
  BaseApiProvider? _videoProvider;
  
  // Provider ç¼“å­˜ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
  final Map<String, BaseApiProvider> _providersCache = {};
  
  /// è®¾ç½® LLM ä¾›åº”å•†
  void setLlmProvider(String providerName, {
    required String baseUrl,
    required String apiKey,
  }) {
    _llmProvider = _getOrCreateProvider(
      providerName: providerName,
      baseUrl: baseUrl,
      apiKey: apiKey,
    );
  }
  
  /// è®¾ç½®å›¾ç‰‡ä¾›åº”å•†
  void setImageProvider(String providerName, {...});
  
  /// è®¾ç½®è§†é¢‘ä¾›åº”å•†
  void setVideoProvider(String providerName, {...});
  
  /// LLM èŠå¤©è¡¥å…¨ï¼ˆè½¬å‘åˆ° _llmProviderï¼‰
  Future<String> chatCompletion({...}) async {
    if (_llmProvider == null) {
      throw Exception('æœªè®¾ç½® LLM æœåŠ¡ä¾›åº”å•†');
    }
    return await _llmProvider!.chatCompletion(...);
  }
  
  // å…¶ä»–æ–¹æ³•ç±»ä¼¼...
}
```

### 4.3 é…ç½®ç®¡ç†

#### **ApiConfigManager**

```dart
// ä½ç½®: lib/services/api_config_manager.dart

/// API é…ç½®ç®¡ç†å™¨ - æŒä¹…åŒ– API é…ç½®
class ApiConfigManager extends ChangeNotifier {
  // ä¸‰ä¸ªç‹¬ç«‹çš„ä¾›åº”å•†é€‰æ‹©
  String _selectedLlmProviderId = 'geeknow';
  String _selectedImageProviderId = 'geeknow';
  String _selectedVideoProviderId = 'geeknow';
  
  // LLM é…ç½®
  String _llmApiKey = '';
  String _llmBaseUrl = '';
  String _llmModel = '';
  
  // å›¾ç‰‡é…ç½®
  String _imageApiKey = '';
  String _imageBaseUrl = '';
  String _imageModel = '';
  
  // è§†é¢‘é…ç½®
  String _videoApiKey = '';
  String _videoBaseUrl = '';
  String _videoModel = '';
  
  /// åŠ è½½é…ç½®ï¼ˆä» SharedPreferencesï¼‰
  Future<void> loadConfig() async {
    final prefs = await SharedPreferences.getInstance();
    
    // åŠ è½½ä¾›åº”å•†é€‰æ‹©
    _selectedLlmProviderId = prefs.getString('selected_llm_provider') ?? 'geeknow';
    _selectedImageProviderId = prefs.getString('selected_image_provider') ?? 'geeknow';
    _selectedVideoProviderId = prefs.getString('selected_video_provider') ?? 'geeknow';
    
    // åŠ è½½ API Key å’Œ Base URL
    _llmApiKey = prefs.getString('llm_api_key') ?? '';
    _llmBaseUrl = prefs.getString('llm_base_url') ?? '';
    // ...
  }
  
  /// ä¿å­˜é…ç½®
  Future<void> saveConfig() async {...}
  
  /// æ‰¹é‡æ›´æ–°é…ç½®
  void updateConfigBatch({
    String? selectedLlmProviderId,
    String? selectedImageProviderId,
    String? selectedVideoProviderId,
    String? llmApiKey,
    String? llmBaseUrl,
    // ...
  }) {...}
}
```

### 4.4 ä½¿ç”¨ç¤ºä¾‹

#### **åˆå§‹åŒ–ï¼ˆåº”ç”¨å¯åŠ¨æ—¶ï¼‰**

```dart
// åœ¨ main.dart ä¸­
void _initializeApiManager() {
  // è¯»å–é…ç½®
  final llmProviderId = apiConfigManager.selectedLlmProviderId;
  final imageProviderId = apiConfigManager.selectedImageProviderId;
  final videoProviderId = apiConfigManager.selectedVideoProviderId;
  
  // åˆ†åˆ«åˆå§‹åŒ–ä¸‰ä¸ª Provider
  ApiManager().setLlmProvider(
    llmProviderId,
    baseUrl: apiConfigManager.llmBaseUrl,
    apiKey: apiConfigManager.llmApiKey,
  );
  
  ApiManager().setImageProvider(
    imageProviderId,
    baseUrl: apiConfigManager.imageBaseUrl,
    apiKey: apiConfigManager.imageApiKey,
  );
  
  ApiManager().setVideoProvider(
    videoProviderId,
    baseUrl: apiConfigManager.videoBaseUrl,
    apiKey: apiConfigManager.videoApiKey,
  );
}
```

#### **è°ƒç”¨ API**

```dart
// åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨
final result = await ApiManager().chatCompletion(
  model: 'gpt-3.5-turbo',
  messages: [
    {'role': 'user', 'content': 'Hello'},
  ],
);
```

### 4.5 æ‰©å±•æ–°ä¾›åº”å•†

è¦æ·»åŠ æ–°çš„ API ä¾›åº”å•†ï¼ˆå¦‚ OpenAIï¼‰ï¼Œåªéœ€ï¼š

1. **åˆ›å»º Provider ç±»**

```dart
// lib/services/providers/openai_provider.dart
class OpenAIProvider extends BaseApiProvider {
  OpenAIProvider({required super.baseUrl, required super.apiKey})
      : super(providerName: 'openai');
  
  @override
  Future<String> chatCompletion({...}) async {
    // OpenAI ç‰¹å®šå®ç°
  }
  
  // å®ç°å…¶ä»–æŠ½è±¡æ–¹æ³•...
}
```

2. **æ›´æ–° ApiManager å·¥å‚æ–¹æ³•**

```dart
// åœ¨ _getOrCreateProvider ä¸­æ·»åŠ  case
BaseApiProvider _getOrCreateProvider({...}) {
  switch (providerName) {
    case 'geeknow':
      return GeeknowProvider(...);
    case 'openai':  // æ–°å¢
      return OpenAIProvider(...);
    default:
      throw Exception('ä¸æ”¯æŒçš„ä¾›åº”å•†: $providerName');
  }
}
```

3. **æ›´æ–°é…ç½®ç®¡ç†**

```dart
// åœ¨ ApiConfigManager ä¸­æ·»åŠ 
List<String> getSupportedProviders() {
  return ['geeknow', 'openai'];  // æ–°å¢
}

String getProviderDisplayName(String providerId) {
  switch (providerId) {
    case 'openai':
      return 'OpenAI';  // æ–°å¢
    // ...
  }
}
```

---

## 5. è‡ªåŠ¨æ¨¡å¼è¯¦è§£

### 5.1 å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¾“å…¥åˆ›æ„                           â”‚
â”‚                  "ä¸€ä¸ªå…³äºå‹‡æ•¢å°çŒ«çš„æ•…äº‹"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1: å‰§æœ¬ç”Ÿæˆ (AutoModeStep.script)                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  â€¢ è°ƒç”¨ LLM API                                             â”‚
â”‚  â€¢ ä½¿ç”¨æç¤ºè¯æ¨¡æ¿                                            â”‚
â”‚  â€¢ ç”Ÿæˆå®Œæ•´å‰§æœ¬                                              â”‚
â”‚  â€¢ ç”¨æˆ·ç¡®è®¤æˆ–ä¿®æ”¹                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2: åˆ†é•œè®¾è®¡ (AutoModeStep.layout)                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  â€¢ åŸºäºå‰§æœ¬è°ƒç”¨ LLM                                          â”‚
â”‚  â€¢ ç”Ÿæˆåˆ†é•œè®¾è®¡                                              â”‚
â”‚  â€¢ ä¸ºæ¯ä¸ªåœºæ™¯ç”Ÿæˆå›¾ç‰‡æç¤ºè¯                                   â”‚
â”‚  â€¢ è§£æä¸º SceneModel åˆ—è¡¨                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3: å›¾ç‰‡ç”Ÿæˆ (AutoModeStep.image)                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  â€¢ å¹¶å‘ç”Ÿæˆæ‰€æœ‰åœºæ™¯å›¾ç‰‡                                       â”‚
â”‚  â€¢ ä½¿ç”¨ Pool é™åˆ¶å¹¶å‘æ•°ï¼ˆæœ€å¤š 2 ä¸ªï¼‰                          â”‚
â”‚  â€¢ æ¯ä¸ªåœºæ™¯ç‹¬ç«‹ä»»åŠ¡ï¼Œå¤±è´¥ä¸å½±å“å…¶ä»–                            â”‚
â”‚  â€¢ å›¾ç‰‡ä¸‹è½½åˆ°æœ¬åœ°                                            â”‚
â”‚  â€¢ å®æ—¶æ›´æ–°è¿›åº¦                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 4: è§†é¢‘ç”Ÿæˆ (AutoModeStep.video)                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚  â€¢ æ‰¹é‡æäº¤è§†é¢‘ç”Ÿæˆä»»åŠ¡                                       â”‚
â”‚  â€¢ è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆå¸¦é€€é¿ç­–ç•¥ï¼‰                                 â”‚
â”‚  â€¢ è§†é¢‘ä¸‹è½½åˆ°æœ¬åœ°                                            â”‚
â”‚  â€¢ å®æ—¶æ›´æ–°è¿›åº¦                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 5: æœ€ç»ˆåˆå¹¶ (AutoModeStep.finalize)                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  â€¢ ä½¿ç”¨ FFmpeg åˆå¹¶æ‰€æœ‰è§†é¢‘                                  â”‚
â”‚  â€¢ ç”Ÿæˆ filelist.txt                                        â”‚
â”‚  â€¢ æ‰§è¡Œ concat demuxer                                      â”‚
â”‚  â€¢ ä¸Šä¼ æœ€ç»ˆè§†é¢‘åˆ° Supabase                                   â”‚
â”‚  â€¢ ä¿å­˜è§†é¢‘ URL                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                         âœ… å®Œæˆ
```

### 5.2 æ•°æ®æ¨¡å‹

#### **AutoModeProject**

```dart
// lib/models/auto_mode_project.dart

class AutoModeProject {
  final String id;                    // é¡¹ç›® IDï¼ˆæ—¶é—´æˆ³ï¼‰
  final String title;                 // é¡¹ç›®æ ‡é¢˜
  AutoModeStep currentStep;           // å½“å‰æ­¥éª¤
  String currentScript;               // ç”Ÿæˆçš„å‰§æœ¬
  String currentLayout;               // ç”Ÿæˆçš„åˆ†é•œè®¾è®¡
  List<SceneModel> scenes;            // åœºæ™¯åˆ—è¡¨
  bool isProcessing;                  // æ˜¯å¦æ­£åœ¨å¤„ç†
  String? errorMessage;               // é”™è¯¯æ¶ˆæ¯
  String? finalVideoUrl;              // æœ€ç»ˆè§†é¢‘ URL
  DateTime? lastModified;             // æœ€åä¿®æ”¹æ—¶é—´
  bool hasUnsavedChanges;            // æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
  bool isSaving;                      // æ˜¯å¦æ­£åœ¨ä¿å­˜
  String? generationStatus;           // ç”ŸæˆçŠ¶æ€
  
  // åºåˆ—åŒ–
  Map<String, dynamic> toJson() {...}
  factory AutoModeProject.fromJson(Map<String, dynamic> json) {...}
}
```

#### **SceneModel**

```dart
// lib/models/scene_model.dart

class SceneModel {
  final int index;                     // åœºæ™¯ç´¢å¼•
  String script;                       // åœºæ™¯å‰§æœ¬
  String imagePrompt;                  // å›¾ç‰‡ç”Ÿæˆæç¤ºè¯
  String? imageUrl;                    // å›¾ç‰‡ URL
  String? videoUrl;                    // è§†é¢‘ URL
  String? localImagePath;              // æœ¬åœ°å›¾ç‰‡è·¯å¾„
  String? localVideoPath;              // æœ¬åœ°è§†é¢‘è·¯å¾„
  SceneStatus status;                  // åœºæ™¯çŠ¶æ€
  String? errorMessage;                // é”™è¯¯æ¶ˆæ¯
  double imageGenerationProgress;      // å›¾ç‰‡ç”Ÿæˆè¿›åº¦
  double videoGenerationProgress;      // è§†é¢‘ç”Ÿæˆè¿›åº¦
  
  Map<String, dynamic> toJson() {...}
  factory SceneModel.fromJson(Map<String, dynamic> json) {...}
}
```

#### **AutoModeStepï¼ˆæšä¸¾ï¼‰**

```dart
// lib/models/auto_mode_step.dart

enum AutoModeStep {
  script,    // å‰§æœ¬ç”Ÿæˆ
  layout,    // åˆ†é•œè®¾è®¡
  image,     // å›¾ç‰‡ç”Ÿæˆ
  video,     // è§†é¢‘åˆæˆ
  finalize,  // æœ€ç»ˆåˆå¹¶
}
```

#### **SceneStatusï¼ˆæšä¸¾ï¼‰**

```dart
// lib/models/scene_status.dart

enum SceneStatus {
  idle,        // ç©ºé—²
  queueing,    // é˜Ÿåˆ—ä¸­
  processing,  // å¤„ç†ä¸­
  success,     // æˆåŠŸ
  error,       // é”™è¯¯
}
```

### 5.3 AutoModeProviderï¼ˆæ ¸å¿ƒçŠ¶æ€ç®¡ç†ï¼‰

```dart
// lib/logic/auto_mode_provider.dart

/// è‡ªåŠ¨æ¨¡å¼çŠ¶æ€ç®¡ç† Providerï¼ˆå•ä¾‹ï¼‰
class AutoModeProvider extends ChangeNotifier {
  static const String _boxName = 'xinghe_auto_mode_v2';
  static Box? _projectsBox;
  
  // å•ä¾‹å®ä¾‹
  static AutoModeProvider? _instance;
  factory AutoModeProvider() {
    _instance ??= AutoModeProvider._internal();
    return _instance!;
  }
  
  // é¡¹ç›®æ˜ å°„ï¼šprojectId -> AutoModeProject
  final Map<String, AutoModeProject> _projects = {};
  
  // å½“å‰æ´»åŠ¨çš„é¡¹ç›® ID
  String? _currentProjectId;
  
  // è‡ªåŠ¨ä¿å­˜ Timer
  final Map<String, Timer> _saveTimers = {};
  
  // å¹¶å‘æ§åˆ¶ï¼ˆå›¾ç‰‡ç”Ÿæˆé™åˆ¶ä¸º 2 ä¸ªï¼‰
  final _imagePool = Pool(2);
  
  // ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ ‡å¿—
  bool _isDisposed = false;
  
  /// åˆå§‹åŒ–ï¼ˆåŠ è½½æ‰€æœ‰é¡¹ç›®ï¼‰
  Future<void> initialize() async {
    if (_isInitialized) return;
    
    try {
      // æ‰“å¼€ Hive Box
      _projectsBox = await Hive.openBox(_boxName);
      
      // åŠ è½½æ‰€æœ‰é¡¹ç›®
      final keys = _projectsBox!.keys.toList();
      for (var key in keys) {
        if (key.toString().startsWith('project_')) {
          final data = _projectsBox!.get(key);
          if (data is Map) {
            final project = AutoModeProject.fromJson(
              Map<String, dynamic>.from(data)
            );
            _projects[project.id] = project;
          }
        }
      }
      
      _isInitialized = true;
      notifyListeners();
    } catch (e, stackTrace) {
      print('âŒ [CRITICAL ERROR CAUGHT] åˆå§‹åŒ–å¤±è´¥: $e');
      print('ğŸ“ [Stack Trace]: $stackTrace');
    }
  }
  
  /// åˆ›å»ºæ–°é¡¹ç›®ï¼ˆä»…ç”± UI è°ƒç”¨ï¼‰
  Future<String> createNewProject(String title) async {
    final projectId = DateTime.now().millisecondsSinceEpoch.toString();
    final project = AutoModeProject(
      id: projectId,
      title: title,
      currentStep: AutoModeStep.script,
      currentScript: '',
      currentLayout: '',
      scenes: [],
      isProcessing: false,
      lastModified: DateTime.now(),
      hasUnsavedChanges: false,
      isSaving: false,
    );
    
    _projects[projectId] = project;
    _currentProjectId = projectId;
    
    // ç«‹å³ä¿å­˜
    await _saveProjectToBox(projectId);
    
    notifyListeners();
    return projectId;
  }
  
  /// å¤„ç†ç”¨æˆ·è¾“å…¥ï¼ˆå‰§æœ¬/åˆ†é•œï¼‰
  Future<void> processInput(String projectId, String input) async {
    final project = _projects[projectId];
    if (project == null) return;
    
    project.isProcessing = true;
    notifyListeners();
    
    try {
      if (project.currentStep == AutoModeStep.script) {
        await _generateScript(projectId, input);
      } else if (project.currentStep == AutoModeStep.layout) {
        await _generateLayout(projectId, input);
      }
    } catch (e, stackTrace) {
      print('âŒ [CRITICAL ERROR CAUGHT] å¤„ç†è¾“å…¥å¤±è´¥: $e');
      print('ğŸ“ [Stack Trace]: $stackTrace');
      project.errorMessage = e.toString();
    } finally {
      project.isProcessing = false;
      notifyListeners();
    }
  }
  
  /// ç”Ÿæˆå‰§æœ¬
  Future<void> _generateScript(String projectId, String input) async {
    print('ğŸ¬ [Script] å¼€å§‹ç”Ÿæˆå‰§æœ¬...');
    
    final project = _projects[projectId]!;
    
    // è°ƒç”¨ LLM API
    final apiService = apiConfigManager.createApiService();
    final prompt = promptStore.getScriptPrompt(input);
    
    final result = await apiService.chatCompletion(
      model: apiConfigManager.llmModel,
      messages: [
        {'role': 'user', 'content': prompt},
      ],
    );
    
    print('ğŸ¬ [Script] æ”¶åˆ° API ç»“æœï¼Œé•¿åº¦: ${result.length}');
    
    // ä¿å­˜å‰§æœ¬
    project.currentScript = result;
    
    print('ğŸ¬ [Script] çŠ¶æ€å·²æ›´æ–°ï¼Œå‰§æœ¬å†…å®¹: ${result.substring(0, 20)}...');
    
    // ä¿å­˜å¹¶é€šçŸ¥
    await _saveProjectToBox(projectId);
    print('ğŸ“¢ [UI Update] é€šçŸ¥ UI æ›´æ–°ï¼Œå½“å‰æ­¥éª¤: ${project.currentStep}, å¤„ç†ä¸­: ${project.isProcessing}');
    notifyListeners();
  }
  
  /// ç”Ÿæˆåˆ†é•œ
  Future<void> _generateLayout(String projectId, String input) async {
    // ç±»ä¼¼ _generateScript...
  }
  
  /// æ‰¹é‡ç”Ÿæˆå›¾ç‰‡ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰
  Future<void> _generateAllImages(String projectId) async {
    final project = _projects[projectId]!;
    
    // ä½¿ç”¨ Pool é™åˆ¶å¹¶å‘æ•°
    final tasks = project.scenes.map((scene) {
      return _imagePool.withResource(() => _generateImage(projectId, scene));
    }).toList();
    
    await Future.wait(tasks, eagerError: false);
  }
  
  /// ç”Ÿæˆå•ä¸ªåœºæ™¯å›¾ç‰‡
  Future<void> _generateImage(String projectId, SceneModel scene) async {
    // è°ƒç”¨å›¾ç‰‡ç”Ÿæˆ API
    // ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°
    // æ›´æ–°åœºæ™¯çŠ¶æ€
    // ä¿å­˜é¡¹ç›®
  }
  
  /// æ‰¹é‡ç”Ÿæˆè§†é¢‘
  Future<void> _generateAllVideos(String projectId) async {
    // æäº¤è§†é¢‘ä»»åŠ¡
    // è½®è¯¢ä»»åŠ¡çŠ¶æ€
    // ä¸‹è½½è§†é¢‘
  }
  
  /// æœ€ç»ˆåˆå¹¶è§†é¢‘
  Future<void> _finalizeVideo(String projectId) async {
    // ä½¿ç”¨ FFmpeg åˆå¹¶æ‰€æœ‰è§†é¢‘
    // ä¸Šä¼ åˆ° Supabase
    // ä¿å­˜è§†é¢‘ URL
  }
  
  /// ä¿å­˜é¡¹ç›®åˆ° Hive Box
  Future<void> _saveProjectToBox(String projectId) async {
    final project = _projects[projectId];
    if (project == null) return;
    
    final key = 'project_$projectId';
    await _projectsBox!.put(key, project.toJson());
    await _projectsBox!.flush();  // å¼ºåˆ¶å†™å…¥ç£ç›˜
    
    print('ğŸ’¾ [Storage] é¡¹ç›®å·²ä¿å­˜: $key');
  }
  
  /// åˆ é™¤é¡¹ç›®
  Future<void> deleteProject(String projectId) async {
    _projects.remove(projectId);
    final key = 'project_$projectId';
    await _projectsBox!.delete(key);
    await _projectsBox!.flush();
    
    if (_currentProjectId == projectId) {
      _currentProjectId = null;
    }
    
    notifyListeners();
  }
}
```

### 5.4 UI ç•Œé¢ï¼ˆAutoModeScreenï¼‰

```dart
// lib/views/auto_mode_screen.dart

class AutoModeScreen extends StatefulWidget {
  final String projectId;
  
  const AutoModeScreen({required this.projectId});
  
  @override
  _AutoModeScreenState createState() => _AutoModeScreenState();
}

class _AutoModeScreenState extends State<AutoModeScreen> {
  late AutoModeProvider _provider;
  
  @override
  void initState() {
    super.initState();
    _provider = AutoModeProvider();
  }
  
  @override
  Widget build(BuildContext context) {
    return ListenableBuilder(
      listenable: _provider,
      builder: (context, _) {
        final project = _provider.getProjectById(widget.projectId);
        
        return Scaffold(
          body: Column(
            children: [
              _buildTopBar(project),        // é¡¶éƒ¨æ 
              _buildStepIndicator(project), // æ­¥éª¤æŒ‡ç¤ºå™¨
              Expanded(
                child: _buildContentArea(project), // å†…å®¹åŒºåŸŸ
              ),
              if (project.currentStep == AutoModeStep.script ||
                  project.currentStep == AutoModeStep.layout)
                _buildInputArea(project),   // è¾“å…¥åŒºåŸŸ
            ],
          ),
        );
      },
    );
  }
  
  Widget _buildContentArea(AutoModeProject project) {
    switch (project.currentStep) {
      case AutoModeStep.script:
      case AutoModeStep.layout:
        return _buildChatArea(project);
      case AutoModeStep.image:
        return _buildImageGenerationArea(project);
      case AutoModeStep.video:
        return _buildVideoGenerationArea(project);
      case AutoModeStep.finalize:
        return _buildFinalizeArea(project);
    }
  }
}
```

---

## 6. æ‰‹åŠ¨æ¨¡å¼è¯¦è§£

### 6.1 å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¿›å…¥ WorkspaceShell
    â†“
é€‰æ‹©åŠŸèƒ½é¢æ¿ï¼ˆå¯¼èˆªæ ï¼‰
    â”œâ”€ ğŸ“– æ•…äº‹ç”Ÿæˆ
    â”œâ”€ ğŸ“ å‰§æœ¬ç”Ÿæˆ
    â”œâ”€ ğŸ¬ åˆ†é•œç”Ÿæˆ
    â”œâ”€ ğŸ‘¤ è§’è‰²ç”Ÿæˆ
    â”œâ”€ ğŸï¸ åœºæ™¯ç”Ÿæˆ
    â””â”€ ğŸ¨ ç‰©å“ç”Ÿæˆ
    â†“
åœ¨é¢æ¿ä¸­ç‹¬ç«‹æ“ä½œ
    - è¾“å…¥æç¤ºè¯
    - é€‰æ‹©æ¨¡æ¿
    - ç”Ÿæˆå†…å®¹
    - ç¼–è¾‘å’Œä¿å­˜
```

### 6.2 åŠŸèƒ½é¢æ¿è¯¦è§£

#### **1. æ•…äº‹ç”Ÿæˆé¢æ¿**

```dart
class StoryGenerationPanel extends StatefulWidget {
  // åŠŸèƒ½ï¼š
  // - è¾“å…¥æ•…äº‹åˆ›æ„
  // - é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆç§‘å¹»/çˆ±æƒ…/æ‚¬ç–‘ç­‰ï¼‰
  // - ç”Ÿæˆå®Œæ•´æ•…äº‹
  // - æ˜¾ç¤ºç»“æœ
  
  // æ•°æ®å­˜å‚¨ï¼š
  // - story_input: è¾“å…¥å†…å®¹
  // - story_output: ç”Ÿæˆç»“æœ
  // - story_prompt_template: é€‰ä¸­çš„æ¨¡æ¿
}
```

#### **2. å‰§æœ¬ç”Ÿæˆé¢æ¿**

```dart
class ScriptGenerationPanel extends StatefulWidget {
  // åŠŸèƒ½ï¼š
  // - è¾“å…¥å‰§æœ¬éœ€æ±‚æˆ–ä»æ•…äº‹å¯¼å…¥
  // - é€‰æ‹©å‰§æœ¬é£æ ¼æ¨¡æ¿
  // - ç”Ÿæˆå‰§æœ¬
  // - æ˜¾ç¤ºç»“æœ
  
  // æ•°æ®å­˜å‚¨ï¼š
  // - script_input: è¾“å…¥å†…å®¹
  // - script_output: ç”Ÿæˆç»“æœ
  // - script_prompt_template: é€‰ä¸­çš„æ¨¡æ¿
}
```

#### **3. åˆ†é•œç”Ÿæˆé¢æ¿**

```dart
class StoryboardGenerationPanel extends StatefulWidget {
  // åŠŸèƒ½ï¼š
  // - è¾“å…¥å‰§æœ¬æˆ–ä»å‰§æœ¬é¢æ¿å¯¼å…¥
  // - é€‰æ‹©å›¾ç‰‡/è§†é¢‘æç¤ºè¯é£æ ¼
  // - ç”Ÿæˆåˆ†é•œåˆ—è¡¨
  // - æ·»åŠ /åˆ é™¤/ç¼–è¾‘åˆ†é•œ
  
  // æ•°æ®ç»“æ„ï¼š
  // List<Map<String, dynamic>> storyboards = [
  //   {
  //     'scene': 'åœºæ™¯1',
  //     'script': 'å‰§æœ¬å†…å®¹',
  //     'imagePrompt': 'å›¾ç‰‡æç¤ºè¯',
  //     'videoPrompt': 'è§†é¢‘æç¤ºè¯',
  //   },
  // ];
}
```

#### **4. è§’è‰²ç”Ÿæˆé¢æ¿**

```dart
class CharacterGenerationPanel extends StatefulWidget {
  // åŠŸèƒ½ï¼š
  // - è¾“å…¥è§’è‰²æè¿°
  // - æ ¹æ®å‰§æœ¬è‡ªåŠ¨æå–è§’è‰²
  // - ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼ˆå›¾ç”Ÿå›¾ï¼‰
  // - ç”Ÿæˆè§’è‰²å›¾ç‰‡
  // - åˆ›å»ºæ•°å­—åˆ†èº«ï¼ˆCharacterï¼‰
  
  // ç‰¹æ®ŠåŠŸèƒ½ï¼š
  // - å‚è€ƒé£æ ¼åŠŸèƒ½
  // - è§†é¢‘ä¸Šä¼ åˆ›å»ºè§’è‰²
  // - Supabase å­˜å‚¨
}
```

#### **5. åœºæ™¯ç”Ÿæˆé¢æ¿**

```dart
class SceneGenerationPanel extends StatefulWidget {
  // åŠŸèƒ½ï¼š
  // - è¾“å…¥åœºæ™¯æè¿°
  // - é€‰æ‹©åœºæ™¯é£æ ¼æ¨¡æ¿
  // - ç”Ÿæˆåœºæ™¯å›¾ç‰‡
  // - ç®¡ç†åœºæ™¯åº“
}
```

#### **6. ç‰©å“ç”Ÿæˆé¢æ¿**

```dart
class PropGenerationPanel extends StatefulWidget {
  // åŠŸèƒ½ï¼š
  // - è¾“å…¥ç‰©å“æè¿°
  // - é€‰æ‹©ç‰©å“é£æ ¼æ¨¡æ¿
  // - ç”Ÿæˆç‰©å“å›¾ç‰‡
  // - ç®¡ç†ç‰©å“åº“
}
```

### 6.3 WorkspaceShellï¼ˆä¸»ç•Œé¢ï¼‰

```dart
// lib/main.dart

class WorkspaceShell extends StatefulWidget {
  @override
  _WorkspaceShellState createState() => _WorkspaceShellState();
}

class _WorkspaceShellState extends State<WorkspaceShell> {
  int _selectedIndex = 0;
  
  // é¢æ¿åˆ—è¡¨
  final List<Widget> _panels = [
    StoryGenerationPanel(),
    ScriptGenerationPanel(),
    StoryboardGenerationPanel(),
    CharacterGenerationPanel(),
    SceneGenerationPanel(),
    PropGenerationPanel(),
  ];
  
  @override
  Widget build(BuildContext context) {
    final isMobile = MediaQuery.of(context).size.width < 800;
    
    return Scaffold(
      body: Row(
        children: [
          // å·¦ä¾§å¯¼èˆªæ ï¼ˆæ¡Œé¢ï¼‰
          if (!isMobile) _buildNavigationRail(),
          
          // ä¸»å†…å®¹åŒº
          Expanded(
            child: Column(
              children: [
                _buildTopBar(),
                Expanded(
                  child: AnimatedSwitcher(
                    duration: Duration(milliseconds: 300),
                    child: _panels[_selectedIndex],
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
      
      // åº•éƒ¨å¯¼èˆªæ ï¼ˆç§»åŠ¨ç«¯ï¼‰
      bottomNavigationBar: isMobile ? _buildBottomNavigationBar() : null,
    );
  }
  
  Widget _buildNavigationRail() {
    return NavigationRail(
      selectedIndex: _selectedIndex,
      onDestinationSelected: (index) {
        setState(() => _selectedIndex = index);
      },
      destinations: [
        NavigationRailDestination(
          icon: Icon(Icons.book_outlined),
          selectedIcon: Icon(Icons.book),
          label: Text('æ•…äº‹ç”Ÿæˆ'),
        ),
        NavigationRailDestination(
          icon: Icon(Icons.description_outlined),
          selectedIcon: Icon(Icons.description),
          label: Text('å‰§æœ¬ç”Ÿæˆ'),
        ),
        // ... å…¶ä»–å¯¼èˆªé¡¹
      ],
    );
  }
}
```

---

## 7. æ•°æ®å­˜å‚¨æ¶æ„

### 7.1 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

| æ¨¡å¼ | å­˜å‚¨æ–¹å¼ | å­˜å‚¨å†…å®¹ | ç‰¹ç‚¹ |
|------|---------|---------|------|
| **è‡ªåŠ¨æ¨¡å¼** | Hive Box (`xinghe_auto_mode_v2`) | å®Œæ•´é¡¹ç›®æ•°æ®ï¼ˆå‰§æœ¬ã€åˆ†é•œã€åœºæ™¯ã€URLï¼‰ | âœ… å¿«é€Ÿè¯»å†™<br>âœ… æ”¯æŒå¤æ‚å¯¹è±¡<br>âœ… å¤šé¡¹ç›®éš”ç¦» |
| **æ‰‹åŠ¨æ¨¡å¼** | SharedPreferences | é¢æ¿è¾“å…¥/è¾“å‡ºã€é…ç½® | âœ… ç®€å•é”®å€¼å¯¹<br>âœ… è·¨å¹³å°å…¼å®¹ |
| **API é…ç½®** | SharedPreferences | API Keyã€Base URLã€æ¨¡å‹é€‰æ‹© | âœ… æŒä¹…åŒ–é…ç½® |
| **æ–‡ä»¶å­˜å‚¨** | Supabase | å›¾ç‰‡ã€è§†é¢‘ã€è§’è‰²æ–‡ä»¶ | âœ… äº‘ç«¯å­˜å‚¨<br>âœ… CDN åŠ é€Ÿ |

### 7.2 è‡ªåŠ¨æ¨¡å¼å­˜å‚¨è¯¦è§£

#### **Hive Box ç»“æ„**

```
Hive Box: xinghe_auto_mode_v2
â”œâ”€â”€ project_1768368504491
â”‚   â””â”€â”€ {
â”‚         "id": "1768368504491",
â”‚         "title": "å‹‡æ•¢çš„å°çŒ«",
â”‚         "currentStep": "script",
â”‚         "currentScript": "...",
â”‚         "currentLayout": "...",
â”‚         "scenes": [
â”‚           {
â”‚             "index": 0,
â”‚             "script": "...",
â”‚             "imagePrompt": "...",
â”‚             "imageUrl": "https://...",
â”‚             "videoUrl": "https://...",
â”‚             "status": "success",
â”‚             ...
â”‚           }
â”‚         ],
â”‚         "finalVideoUrl": "https://...",
â”‚         ...
â”‚       }
â”œâ”€â”€ project_1768368512345
â”‚   â””â”€â”€ { ... }
â””â”€â”€ ...
```

#### **å…³é”®æ“ä½œ**

```dart
// ä¿å­˜é¡¹ç›®
Future<void> _saveProjectToBox(String projectId) async {
  final project = _projects[projectId];
  final key = 'project_$projectId';
  await _projectsBox!.put(key, project.toJson());
  await _projectsBox!.flush();  // å¼ºåˆ¶å†™å…¥ç£ç›˜ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰
}

// åŠ è½½é¡¹ç›®
Future<void> _loadAllProjects() async {
  final keys = _projectsBox!.keys.toList();
  for (var key in keys) {
    if (key.toString().startsWith('project_')) {
      final data = _projectsBox!.get(key);
      final project = AutoModeProject.fromJson(
        Map<String, dynamic>.from(data)
      );
      _projects[project.id] = project;
    }
  }
}

// åˆ é™¤é¡¹ç›®
Future<void> deleteProject(String projectId) async {
  _projects.remove(projectId);
  await _projectsBox!.delete('project_$projectId');
  await _projectsBox!.flush();
}
```

### 7.3 æ‰‹åŠ¨æ¨¡å¼å­˜å‚¨è¯¦è§£

#### **SharedPreferences é”®å€¼å¯¹**

```
SharedPreferences
â”œâ”€â”€ story_input: "ç”¨æˆ·è¾“å…¥çš„æ•…äº‹åˆ›æ„"
â”œâ”€â”€ story_output: "ç”Ÿæˆçš„æ•…äº‹å†…å®¹"
â”œâ”€â”€ story_prompt_template: "selected_template_id"
â”œâ”€â”€ script_input: "..."
â”œâ”€â”€ script_output: "..."
â”œâ”€â”€ storyboards: "[{...}, {...}]" (JSON æ•°ç»„)
â”œâ”€â”€ workspace_characters: "[{...}]" (è§’è‰²åˆ—è¡¨)
â”œâ”€â”€ character_reference_style_image: "/path/to/image"
â”œâ”€â”€ character_reference_style_prompt: "..."
â””â”€â”€ ...
```

#### **å…³é”®æ“ä½œ**

```dart
// ä¿å­˜æ•°æ®
Future<void> _saveStory() async {
  final prefs = await SharedPreferences.getInstance();
  await prefs.setString('story_input', _inputController.text);
  await prefs.setString('story_output', _generatedStory);
}

// åŠ è½½æ•°æ®
Future<void> _loadStory() async {
  final prefs = await SharedPreferences.getInstance();
  _inputController.text = prefs.getString('story_input') ?? '';
  _generatedStory = prefs.getString('story_output') ?? '';
  setState(() {});
}

// ä¿å­˜åˆ—è¡¨æ•°æ®
Future<void> _saveStoryboards() async {
  final prefs = await SharedPreferences.getInstance();
  final json = jsonEncode(_storyboards);
  await prefs.setString('storyboards', json);
}

// åŠ è½½åˆ—è¡¨æ•°æ®
Future<void> _loadStoryboards() async {
  final prefs = await SharedPreferences.getInstance();
  final json = prefs.getString('storyboards');
  if (json != null) {
    _storyboards = List<Map<String, dynamic>>.from(
      jsonDecode(json)
    );
  }
}
```

### 7.4 API é…ç½®å­˜å‚¨

```
SharedPreferences (API é…ç½®)
â”œâ”€â”€ selected_llm_provider: "geeknow"
â”œâ”€â”€ selected_image_provider: "geeknow"
â”œâ”€â”€ selected_video_provider: "geeknow"
â”œâ”€â”€ llm_api_key: "..."
â”œâ”€â”€ llm_base_url: "https://..."
â”œâ”€â”€ llm_model: "gpt-3.5-turbo"
â”œâ”€â”€ image_api_key: "..."
â”œâ”€â”€ image_base_url: "https://..."
â”œâ”€â”€ image_model: "..."
â”œâ”€â”€ video_api_key: "..."
â”œâ”€â”€ video_base_url: "https://..."
â””â”€â”€ video_model: "..."
```

### 7.5 Supabase æ–‡ä»¶å­˜å‚¨

```
Supabase Storage
â”œâ”€â”€ Buckets
â”‚   â”œâ”€â”€ videos/           # è§†é¢‘æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ user-upload-xxx.mp4
â”‚   â”‚   â””â”€â”€ final-video-xxx.mp4
â”‚   â”œâ”€â”€ characters/       # è§’è‰²æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ character-xxx.mp4
â”‚   â””â”€â”€ images/           # å›¾ç‰‡æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â”‚       â””â”€â”€ scene-xxx.png
```

---

## 8. æœåŠ¡å±‚è®¾è®¡

### 8.1 æœåŠ¡å±‚æ¶æ„

```
Services å±‚
â”œâ”€â”€ API æœåŠ¡
â”‚   â”œâ”€â”€ ApiManager (æ··åˆä¾›åº”å•†ç®¡ç†)
â”‚   â”œâ”€â”€ ApiService (ç»Ÿä¸€ API æ¥å£)
â”‚   â”œâ”€â”€ ApiConfigManager (é…ç½®ç®¡ç†)
â”‚   â””â”€â”€ Providers (ä¾›åº”å•†å®ç°)
â”‚       â”œâ”€â”€ BaseApiProvider (åŸºç±»)
â”‚       â”œâ”€â”€ GeeknowProvider (Geeknow å®ç°)
â”‚       â””â”€â”€ [æœªæ¥] OpenAIProvider, StabilityAIProvider...
â”œâ”€â”€ ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ HeavyTaskRunner (é‡ä»»åŠ¡æ‰§è¡Œ)
â”‚   â”œâ”€â”€ GenerationQueue (ç”Ÿæˆé˜Ÿåˆ—)
â”‚   â””â”€â”€ FFmpegService (è§†é¢‘å¤„ç†)
â”œâ”€â”€ æ•°æ®æœåŠ¡
â”‚   â””â”€â”€ PromptStore (æç¤ºè¯æ¨¡æ¿ç®¡ç†)
â””â”€â”€ å·¥å…·æœåŠ¡
    â””â”€â”€ UpdateService (è‡ªåŠ¨æ›´æ–°)
```

### 8.2 HeavyTaskRunnerï¼ˆå¹¶å‘ä»»åŠ¡ç®¡ç†ï¼‰

```dart
// lib/services/heavy_task_runner.dart

/// é‡ä»»åŠ¡æ‰§è¡Œå™¨ - åœ¨ Isolate ä¸­æ‰§è¡Œé‡æ“ä½œ
class HeavyTaskRunner {
  /// åœ¨ Isolate ä¸­è§£æ JSONï¼ˆé¿å…é˜»å¡ UIï¼‰
  static Future<dynamic> parseJson(String jsonString) async {
    return await compute(_parseJsonIsolate, jsonString);
  }
  
  static dynamic _parseJsonIsolate(String jsonString) {
    return jsonDecode(jsonString);
  }
  
  /// åœ¨ Isolate ä¸­è§£ç  Base64
  static Future<Uint8List> decodeBase64(String base64String) async {
    return await compute(_decodeBase64Isolate, base64String);
  }
  
  static Uint8List _decodeBase64Isolate(String base64String) {
    return base64Decode(base64String);
  }
  
  /// åœ¨ Isolate ä¸­å†™å…¥æ–‡ä»¶
  static Future<void> writeFile(String path, Uint8List bytes) async {
    await compute(_writeFileIsolate, {'path': path, 'bytes': bytes});
  }
  
  static void _writeFileIsolate(Map<String, dynamic> params) {
    final file = File(params['path']);
    file.writeAsBytesSync(params['bytes']);
  }
  
  /// æ¸…ç†å›¾ç‰‡ç¼“å­˜
  static void clearImageCache() {
    PaintingBinding.instance.imageCache.clear();
    PaintingBinding.instance.imageCache.clearLiveImages();
  }
}
```

### 8.3 PromptStoreï¼ˆæç¤ºè¯æ¨¡æ¿ç®¡ç†ï¼‰

```dart
// lib/services/prompt_store.dart

/// æç¤ºè¯æ¨¡æ¿ç®¡ç†å™¨
class PromptStore {
  static final PromptStore _instance = PromptStore._internal();
  factory PromptStore() => _instance;
  
  final List<PromptTemplate> _templates = [];
  
  /// åˆå§‹åŒ–ï¼ˆåŠ è½½å†…ç½®æ¨¡æ¿ï¼‰
  Future<void> initialize() async {
    _templates.addAll([
      PromptTemplate(
        id: 'story_scifi',
        category: 'story',
        name: 'ç§‘å¹»æ•…äº‹',
        content: 'è¯·æ ¹æ®ä»¥ä¸‹åˆ›æ„ç”Ÿæˆä¸€ä¸ªç§‘å¹»æ•…äº‹...',
      ),
      PromptTemplate(
        id: 'script_drama',
        category: 'script',
        name: 'å‰§æƒ…ç‰‡å‰§æœ¬',
        content: 'è¯·å°†ä»¥ä¸‹æ•…äº‹æ”¹ç¼–ä¸ºå‰§æƒ…ç‰‡å‰§æœ¬...',
      ),
      // ... æ›´å¤šæ¨¡æ¿
    ]);
  }
  
  /// è·å–åˆ†ç±»æ¨¡æ¿
  List<PromptTemplate> getTemplatesByCategory(String category) {
    return _templates.where((t) => t.category == category).toList();
  }
  
  /// è·å–å‰§æœ¬ç”Ÿæˆæç¤ºè¯
  String getScriptPrompt(String userInput) {
    return '''
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–å‰§ã€‚è¯·æ ¹æ®ä»¥ä¸‹åˆ›æ„ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„å‰§æœ¬ã€‚

åˆ›æ„ï¼š$userInput

è¦æ±‚ï¼š
1. åŒ…å«å¼€å¤´ã€å‘å±•ã€é«˜æ½®ã€ç»“å°¾
2. è§’è‰²æ€§æ ¼é²œæ˜
3. å¯¹è¯è‡ªç„¶
4. åœºæ™¯æå†™è¯¦ç»†
''';
  }
  
  /// è·å–åˆ†é•œç”Ÿæˆæç¤ºè¯
  String getLayoutPrompt(String script) {
    return '''
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œè®¾è®¡å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹å‰§æœ¬ç”Ÿæˆåˆ†é•œè®¾è®¡ã€‚

å‰§æœ¬ï¼š$script

è¦æ±‚ï¼š
1. å°†å‰§æœ¬åˆ†ä¸º 3-6 ä¸ªåœºæ™¯
2. ä¸ºæ¯ä¸ªåœºæ™¯ç”Ÿæˆå›¾ç‰‡æç¤ºè¯ï¼ˆç”¨äº AI å›¾ç‰‡ç”Ÿæˆï¼‰
3. ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼š

{
  "scenes": [
    {
      "index": 0,
      "script": "åœºæ™¯å‰§æœ¬å†…å®¹",
      "imagePrompt": "è‹±æ–‡å›¾ç‰‡æç¤ºè¯ï¼Œæè¿°åœºæ™¯çš„è§†è§‰å…ƒç´ "
    },
    ...
  ]
}

æ³¨æ„ï¼šåªè¾“å‡º JSONï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ã€‚
''';
  }
}
```

### 8.4 FFmpegServiceï¼ˆè§†é¢‘å¤„ç†ï¼‰

```dart
// lib/services/ffmpeg_service.dart

/// FFmpeg è§†é¢‘å¤„ç†æœåŠ¡
class FFmpegService {
  /// åˆå¹¶å¤šä¸ªè§†é¢‘
  /// 
  /// [videoPaths] è§†é¢‘æ–‡ä»¶è·¯å¾„åˆ—è¡¨
  /// [outputPath] è¾“å‡ºæ–‡ä»¶è·¯å¾„
  /// è¿”å›æ˜¯å¦æˆåŠŸ
  static Future<bool> concatVideos(
    List<String> videoPaths,
    String outputPath,
  ) async {
    try {
      // åˆ›å»ºä¸´æ—¶æ–‡ä»¶åˆ—è¡¨
      final tempDir = await getTemporaryDirectory();
      final fileListPath = '${tempDir.path}/filelist.txt';
      
      // å†™å…¥æ–‡ä»¶åˆ—è¡¨
      final fileListContent = videoPaths
          .map((path) => "file '$path'")
          .join('\n');
      await File(fileListPath).writeAsString(fileListContent);
      
      // æ‰§è¡Œ FFmpeg å‘½ä»¤
      final result = await Process.run('ffmpeg', [
        '-f', 'concat',
        '-safe', '0',
        '-i', fileListPath,
        '-c', 'copy',
        outputPath,
      ]);
      
      if (result.exitCode != 0) {
        print('âŒ FFmpeg é”™è¯¯: ${result.stderr}');
        return false;
      }
      
      print('âœ… è§†é¢‘åˆå¹¶æˆåŠŸ: $outputPath');
      return true;
    } catch (e, stackTrace) {
      print('âŒ [CRITICAL ERROR CAUGHT] FFmpeg åˆå¹¶å¤±è´¥: $e');
      print('ğŸ“ [Stack Trace]: $stackTrace');
      return false;
    }
  }
  
  /// è½¬æ¢è§†é¢‘æ ¼å¼
  static Future<bool> convertVideo(
    String inputPath,
    String outputPath,
    String format,
  ) async {
    // å®ç°è§†é¢‘æ ¼å¼è½¬æ¢
  }
}
```

---

## 9. çŠ¶æ€ç®¡ç†

### 9.1 çŠ¶æ€ç®¡ç†ç­–ç•¥

| åœºæ™¯ | æ–¹æ¡ˆ | åŸå›  |
|------|------|------|
| **è‡ªåŠ¨æ¨¡å¼** | `ChangeNotifier` (AutoModeProvider) | âœ… å¤æ‚çŠ¶æ€<br>âœ… å¤šç»„ä»¶å…±äº«<br>âœ… å•ä¾‹æ¨¡å¼ |
| **æ‰‹åŠ¨æ¨¡å¼** | `StatefulWidget` çš„ `setState` | âœ… ç®€å•çŠ¶æ€<br>âœ… å±€éƒ¨åˆ·æ–°<br>âœ… é¢æ¿ç‹¬ç«‹ |
| **API é…ç½®** | `ChangeNotifier` (ApiConfigManager) | âœ… å…¨å±€é…ç½®<br>âœ… æŒä¹…åŒ– |
| **ä¸»é¢˜** | `ChangeNotifier` (ThemeManager) | âœ… å…¨å±€ä¸»é¢˜ |

### 9.2 AutoModeProvider çŠ¶æ€ç®¡ç†è¯¦è§£

```dart
// ä½¿ç”¨ç¤ºä¾‹ï¼šåœ¨ UI ä¸­ç›‘å¬çŠ¶æ€å˜åŒ–

class AutoModeScreen extends StatefulWidget {
  @override
  _AutoModeScreenState createState() => _AutoModeScreenState();
}

class _AutoModeScreenState extends State<AutoModeScreen> {
  late AutoModeProvider _provider;
  
  @override
  void initState() {
    super.initState();
    _provider = AutoModeProvider();
    _provider.addListener(_onProviderUpdate);
  }
  
  @override
  void dispose() {
    _provider.removeListener(_onProviderUpdate);
    super.dispose();
  }
  
  void _onProviderUpdate() {
    // çŠ¶æ€æ›´æ–°æ—¶è°ƒç”¨
    if (mounted) {
      setState(() {});
    }
  }
  
  @override
  Widget build(BuildContext context) {
    // ä½¿ç”¨ _provider çš„æ•°æ®æ„å»º UI
  }
}

// æˆ–ä½¿ç”¨ ListenableBuilder
Widget build(BuildContext context) {
  return ListenableBuilder(
    listenable: AutoModeProvider(),
    builder: (context, _) {
      final provider = AutoModeProvider();
      return Text(provider.currentScript);
    },
  );
}
```

---

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 è‡ªåŠ¨æ¨¡å¼æ€§èƒ½ä¼˜åŒ–

#### **1. å¹¶å‘æ§åˆ¶**

```dart
// ä½¿ç”¨ Pool é™åˆ¶å¹¶å‘æ•°ï¼ˆé¿å… UI å†»ç»“ï¼‰
final _imagePool = Pool(2);  // æœ€å¤š 2 ä¸ªå¹¶å‘å›¾ç‰‡ç”Ÿæˆä»»åŠ¡

Future<void> _generateAllImages(String projectId) async {
  final project = _projects[projectId]!;
  
  final tasks = project.scenes.map((scene) {
    return _imagePool.withResource(() => _generateImage(projectId, scene));
  }).toList();
  
  await Future.wait(tasks, eagerError: false);
}
```

#### **2. Isolate å¤„ç†é‡æ“ä½œ**

```dart
// åœ¨ Isolate ä¸­è§£æ JSONï¼ˆé¿å…é˜»å¡ UIï¼‰
final parsed = await HeavyTaskRunner.parseJson(response.body);

// åœ¨ Isolate ä¸­å†™å…¥æ–‡ä»¶
await HeavyTaskRunner.writeFile(filePath, bytes);
```

#### **3. å›¾ç‰‡ç¼“å­˜ç®¡ç†**

```dart
// å®šæœŸæ¸…ç†å›¾ç‰‡ç¼“å­˜ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰
HeavyTaskRunner.clearImageCache();
```

#### **4. é˜²æŠ–ä¿å­˜**

```dart
// å»¶è¿Ÿä¿å­˜ï¼ˆé¿å…é¢‘ç¹ç£ç›˜å†™å…¥ï¼‰
void _scheduleSave(String projectId) {
  _saveTimers[projectId]?.cancel();
  _saveTimers[projectId] = Timer(Duration(milliseconds: 500), () {
    _saveProjectToBox(projectId);
  });
}
```

### 10.2 æ‰‹åŠ¨æ¨¡å¼æ€§èƒ½ä¼˜åŒ–

#### **1. é¢æ¿æ‡’åŠ è½½**

```dart
// åªæ¸²æŸ“å½“å‰é€‰ä¸­çš„é¢æ¿
AnimatedSwitcher(
  duration: Duration(milliseconds: 300),
  child: _panels[_selectedIndex],  // åªæ„å»ºä¸€ä¸ªé¢æ¿
)
```

#### **2. å“åº”å¼å¸ƒå±€**

```dart
// æ ¹æ®å±å¹•å¤§å°è°ƒæ•´å¸ƒå±€
final isMobile = MediaQuery.of(context).size.width < 800;

if (isMobile) {
  // ç§»åŠ¨ç«¯å¸ƒå±€
} else {
  // æ¡Œé¢å¸ƒå±€
}
```

### 10.3 API è°ƒç”¨ä¼˜åŒ–

#### **1. Provider ç¼“å­˜**

```dart
// é¿å…ä¸ºç›¸åŒé…ç½®é‡å¤åˆ›å»º Provider
final Map<String, BaseApiProvider> _providersCache = {};

BaseApiProvider _getOrCreateProvider({...}) {
  final cacheKey = '$providerName:$baseUrl:$apiKey';
  
  if (_providersCache.containsKey(cacheKey)) {
    return _providersCache[cacheKey]!;
  }
  
  final provider = GeeknowProvider(...);
  _providersCache[cacheKey] = provider;
  return provider;
}
```

#### **2. æŒ‡æ•°é€€é¿è½®è¯¢**

```dart
// è§†é¢‘ç”Ÿæˆä»»åŠ¡è½®è¯¢ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
int pollInterval = 2000;  // åˆå§‹ 2 ç§’
final maxInterval = 30000;  // æœ€å¤§ 30 ç§’

while (true) {
  final status = await _apiService.getVideoTask(taskId: taskId);
  
  if (status.completed) break;
  
  await Future.delayed(Duration(milliseconds: pollInterval));
  
  // æŒ‡æ•°å¢é•¿ï¼Œä½†ä¸è¶…è¿‡æœ€å¤§å€¼
  pollInterval = (pollInterval * 1.5).toInt().clamp(2000, maxInterval);
}
```

---

## 11. ä»£ç è§„èŒƒ

### 11.1 Flutter ä¸“å®¶è®¾ç½®ï¼ˆå·²é…ç½®ï¼‰

æ ¹æ®é¡¹ç›®ä¸­çš„ `repo_specific_rule`ï¼Œå·²é…ç½®ä»¥ä¸‹è§„èŒƒï¼š

#### **1. æ€§èƒ½ä¼˜å…ˆï¼ˆéé˜»å¡ï¼‰**

```dart
// âŒ é”™è¯¯ï¼šåœ¨ Main Thread è§£æ JSON
final data = jsonDecode(response.body);  // é˜»å¡ UI

// âœ… æ­£ç¡®ï¼šåœ¨ Isolate ä¸­è§£æ
final data = await compute(jsonDecode, response.body);
// æˆ–ä½¿ç”¨
final data = await HeavyTaskRunner.parseJson(response.body);
```

#### **2. FFmpeg å¤„ç†**

```dart
// âœ… æ‰€æœ‰ FFmpeg æ“ä½œå¿…é¡»å¼‚æ­¥
final success = await FFmpegService.concatVideos(videoPaths, outputPath);
```

#### **3. å›¾ç‰‡ç¼“å­˜**

```dart
// âœ… ä½¿ç”¨ cached_network_imageï¼ˆæœªæ¥é›†æˆï¼‰
CachedNetworkImage(
  imageUrl: scene.imageUrl,
  placeholder: (context, url) => CircularProgressIndicator(),
)
```

### 11.2 API æ™ºèƒ½è½®è¯¢

```dart
// âŒ é”™è¯¯ï¼šå›ºå®šé—´éš”è½®è¯¢
Timer.periodic(Duration(seconds: 5), (_) => checkStatus());

// âœ… æ­£ç¡®ï¼šæŒ‡æ•°é€€é¿è½®è¯¢
int interval = 2000;
while (!completed) {
  await checkStatus();
  await Future.delayed(Duration(milliseconds: interval));
  interval = (interval * 1.5).toInt().clamp(2000, 30000);
}
```

### 11.3 é”™è¯¯å¤„ç†

```dart
// âœ… æ‰€æœ‰ API è°ƒç”¨å¿…é¡»åŒ…å« try-catch
try {
  final result = await apiService.chatCompletion(...);
} catch (e, stackTrace) {
  print('âŒ [CRITICAL ERROR CAUGHT] API è°ƒç”¨å¤±è´¥: $e');
  print('ğŸ“ [Stack Trace]: $stackTrace');
  // å¤„ç†é”™è¯¯
}

// âŒ ç¦æ­¢ç©º catch å—
try {
  // ...
} catch (e) {
  // ç©ºçš„ catch å— - é™é»˜å¤±è´¥ï¼Œéš¾ä»¥è°ƒè¯•
}
```

### 11.4 æ—¥å¿—è§„èŒƒ

```dart
// âœ… è¯·æ±‚æ—¥å¿—
print('ğŸš€ [API Request] URL: $url');
print('ğŸ“¦ [API Payload]: $body');

// âœ… å“åº”æ—¥å¿—
print('âœ… [API Response] Code: ${response.statusCode}');
print('ğŸ“„ [API Body Raw]: ${response.body}');

// âœ… æ­¥éª¤æ—¥å¿—
print('ğŸ“¢ [UI Update] é€šçŸ¥ UI æ›´æ–°ï¼Œå½“å‰æ­¥éª¤: $currentStep');

// âœ… é”™è¯¯æ—¥å¿—
print('âŒ [CRITICAL ERROR CAUGHT] $e');
print('ğŸ“ [Stack Trace]: $stackTrace');
```

---

## 12. å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 12.1 å·²è§£å†³çš„é—®é¢˜

#### **1. æ•°æ®ä¸¢å¤±é—®é¢˜** âœ…

**é—®é¢˜**: Hive Box æ•°æ®æœªåŠæ—¶å†™å…¥ç£ç›˜

**è§£å†³æ–¹æ¡ˆ**:
```dart
await _projectsBox!.put(key, data);
await _projectsBox!.flush();  // å¼ºåˆ¶å†™å…¥ç£ç›˜
```

#### **2. é¡¹ç›®é‡å¤é—®é¢˜** âœ…

**é—®é¢˜**: é¡¹ç›® ID å‰ç¼€ä¸ä¸€è‡´å¯¼è‡´é‡å¤

**è§£å†³æ–¹æ¡ˆ**:
```dart
// ç»Ÿä¸€å­˜å‚¨é”®æ ¼å¼
final key = 'project_$projectId';
await _projectsBox!.put(key, data);

// è‡ªåŠ¨å¤„ç†å‰ç¼€é—®é¢˜
AutoModeProject? getProjectById(String projectId) {
  if (_projects.containsKey(projectId)) {
    return _projects[projectId];
  }
  if (!projectId.startsWith('project_')) {
    return _projects['project_$projectId'];
  }
  // ...
}
```

#### **3. å¹¶å‘å´©æºƒé—®é¢˜** âœ…

**é—®é¢˜**: åŒæ—¶ç”Ÿæˆå¤§é‡å›¾ç‰‡å¯¼è‡´ UI å†»ç»“

**è§£å†³æ–¹æ¡ˆ**:
```dart
// ä½¿ç”¨ Pool é™åˆ¶å¹¶å‘æ•°
final _imagePool = Pool(2);

final tasks = scenes.map((scene) {
  return _imagePool.withResource(() => _generateImage(scene));
}).toList();
```

#### **4. ç”Ÿå‘½å‘¨æœŸé”™è¯¯** âœ…

**é—®é¢˜**: Provider disposed åä»è°ƒç”¨ `notifyListeners()`

**è§£å†³æ–¹æ¡ˆ**:
```dart
bool _isDisposed = false;

void _safeNotifyListeners() {
  if (!_isDisposed) {
    notifyListeners();
  }
}

@override
void dispose() {
  _isDisposed = true;
  super.dispose();
}
```

### 12.2 å½“å‰é™åˆ¶

1. **FFmpeg ä¾èµ–**: ç”¨æˆ·éœ€æ‰‹åŠ¨å®‰è£… FFmpeg å¹¶é…ç½® PATH
2. **å•ä¾›åº”å•†**: ç›®å‰åªæ”¯æŒ Geeknow API
3. **æ— ç¦»çº¿æ¨¡å¼**: éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½

---

## 13. æœªæ¥æ‰©å±•æ–¹å‘

### 13.1 API ä¾›åº”å•†æ‰©å±•

```
å½“å‰æ”¯æŒï¼š
â”œâ”€â”€ Geeknow âœ…

è®¡åˆ’æ”¯æŒï¼š
â”œâ”€â”€ OpenAI (GPT, DALL-E)
â”œâ”€â”€ Anthropic (Claude)
â”œâ”€â”€ Stability AI (Stable Diffusion)
â”œâ”€â”€ Runway (Gen-2)
â””â”€â”€ æœ¬åœ°æ¨¡å‹ (Ollama)
```

### 13.2 åŠŸèƒ½æ‰©å±•

- [ ] **éŸ³é¢‘ç”Ÿæˆ**: TTSï¼ˆæ–‡å­—è½¬è¯­éŸ³ï¼‰ã€BGM ç”Ÿæˆ
- [ ] **å­—å¹•ç”Ÿæˆ**: è‡ªåŠ¨ä¸ºè§†é¢‘æ·»åŠ å­—å¹•
- [ ] **ç‰¹æ•ˆå’Œè½¬åœº**: æ›´ä¸°å¯Œçš„è§†é¢‘æ•ˆæœ
- [ ] **åä½œæ¨¡å¼**: å¤šäººåä½œåˆ›ä½œ
- [ ] **æ¨¡æ¿å¸‚åœº**: é¢„è®¾æ¨¡æ¿å’Œé£æ ¼

### 13.3 æ€§èƒ½ä¼˜åŒ–

- [ ] **å¢é‡ä¿å­˜**: åªä¿å­˜å˜æ›´çš„æ•°æ®
- [ ] **åå°ä»»åŠ¡**: ä½¿ç”¨ WorkManager è¿›è¡Œåå°å¤„ç†
- [ ] **CDN åŠ é€Ÿ**: å›¾ç‰‡å’Œè§†é¢‘ CDN ç¼“å­˜

### 13.4 å¹³å°æ‰©å±•

- [ ] **ç§»åŠ¨ç«¯ä¼˜åŒ–**: æ›´å¥½çš„è§¦æ‘¸ä½“éªŒ
- [ ] **Web ç‰ˆæœ¬**: æµè§ˆå™¨ä¸­ä½¿ç”¨
- [ ] **æ¡Œé¢åŸç”Ÿ**: Electron æˆ–åŸç”Ÿåº”ç”¨

---

## 14. å¿«é€Ÿå‚è€ƒ

### 14.1 å…³é”®æ–‡ä»¶é€ŸæŸ¥

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| **åº”ç”¨å…¥å£** | `lib/main.dart` |
| **è‡ªåŠ¨æ¨¡å¼çŠ¶æ€** | `lib/logic/auto_mode_provider.dart` |
| **è‡ªåŠ¨æ¨¡å¼ UI** | `lib/views/auto_mode_screen.dart` |
| **API ç®¡ç†** | `lib/services/api_manager.dart` |
| **API é…ç½®** | `lib/services/api_config_manager.dart` |
| **API ä¾›åº”å•†åŸºç±»** | `lib/services/providers/base_provider.dart` |
| **Geeknow å®ç°** | `lib/services/providers/geeknow_provider.dart` |
| **FFmpeg æœåŠ¡** | `lib/services/ffmpeg_service.dart` |
| **é¡¹ç›®æ¨¡å‹** | `lib/models/auto_mode_project.dart` |
| **åœºæ™¯æ¨¡å‹** | `lib/models/scene_model.dart` |

### 14.2 å¸¸ç”¨å‘½ä»¤

```bash
# è¿è¡Œåº”ç”¨
flutter run

# æ„å»º Windows ç‰ˆæœ¬
flutter build windows

# æ¸…ç†æ„å»ºç¼“å­˜
flutter clean

# è·å–ä¾èµ–
flutter pub get

# æ£€æŸ¥ä»£ç 
flutter analyze
```

### 14.3 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
```

---

## 15. æ€»ç»“

**æ˜Ÿæ²³ï¼ˆXingheï¼‰** æ˜¯ä¸€æ¬¾åŠŸèƒ½å®Œæ•´ã€æ¶æ„æ¸…æ™°çš„ AI è§†é¢‘åˆ›ä½œè½¯ä»¶ï¼š

âœ… **åŒæ¨¡å¼å·¥ä½œæµ**: è‡ªåŠ¨æ¨¡å¼ + æ‰‹åŠ¨æ¨¡å¼  
âœ… **æ’ä»¶åŒ– API æ¶æ„**: æ”¯æŒå¤šä¾›åº”å•† Mix & Match  
âœ… **å®Œæ•´çš„çŠ¶æ€ç®¡ç†**: ChangeNotifier + StatefulWidget  
âœ… **å¥å£®çš„æ•°æ®å­˜å‚¨**: Hive + SharedPreferences + Supabase  
âœ… **æ€§èƒ½ä¼˜åŒ–**: Isolate + å¹¶å‘æ§åˆ¶ + ç¼“å­˜  
âœ… **ä»£ç è´¨é‡**: å®Œæ•´é”™è¯¯å¤„ç† + è¯¦ç»†æ—¥å¿—  
âœ… **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°ä¾›åº”å•†å’ŒåŠŸèƒ½  

è¿™ä»½æ–‡æ¡£æä¾›äº†è½¯ä»¶çš„å®Œæ•´æŠ€æœ¯è§†å›¾ï¼Œé€‚åˆç”¨äºï¼š
- å‘å…¶ä»– AI å¤§è¯­è¨€æ¨¡å‹ä»‹ç»é¡¹ç›®
- æ–°å¼€å‘è€…å¿«é€Ÿäº†è§£æ¶æ„
- è§„åˆ’æœªæ¥çš„åŠŸèƒ½æ‰©å±•
- æ•…éšœæ’æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–

---

**æ–‡æ¡£ç»“æŸ**
